# Changelog

## [Non publié] - 2026-02-13 20:31

### Added (Ajouté)
- **Onglet Paramétrage XFoil** complet dans `tab_xfoil.py` :
  - Saisie Reynolds (min/max/pas), Alpha (min/max/pas)
  - Paramètres XFoil (viscosité, NCRIT, XTR, repanel, npanel, timeout)
  - 3 boutons de lancement sélectif : "Lancer les 2", "Courant seul", "Référence seul"
  - Signal `run_requested(str)` avec cible 'both'/'current'/'reference'
- **Onglet Résultats** avec grille configurable dans `tab_results.py` :
  - Grille NxM de `ResultCell` (défaut 2×2)
  - Méthodes `set_results()` (remplacement) et `update_results()` (merge partiel)
  - Bandeau d'avertissement "résultats obsolètes" par profil
  - Méthode `mark_stale(role)` pour signaler les profils modifiés
- **Cellule d'analyse** `result_cell.py` (643 lignes) :
  - Canvas matplotlib interactif (zoom molette, pan bouton milieu, coordonnées curseur)
  - Combo d'analyse avec 18 types prédéfinis
  - Checkboxes courant (C) / référence (R) par cellule
  - Légende interactive (clic pour masquer/afficher une courbe)
  - Menu contextuel : tout afficher / tout masquer
  - Persistance des courbes masquées lors du changement de Reynolds
  - Combo Reynolds (visible pour -Cp(x)) avec sélection par Re
- **18 analyses prédéfinies** dans `ANALYSIS_REGISTRY` :
  - Polaires : CL(α), CD(α), Finesse(α), CL(CD), CM(α), Xtr(α), CDp(α)
  - Distribution pression : -Cp(x) avec sélecteur Reynolds
  - Couche limite f(s) : Ue(s), δ*(s), θ(s), Cf(s), H(s)
  - Couche limite f(x) : Ue(x), δ*(x), θ(x), Cf(x), H(x)
- **Worker de simulation** `simulation_worker.py` :
  - `SimulationWorker(QThread)` avec signaux progress/finished_ok/finished_error
- **Orchestration simulation** dans `main_window.py` :
  - Lancement sélectif (both/current/reference) via le worker
  - Merge partiel des résultats pour simulation d'un seul profil
  - Bascule automatique vers l'onglet Résultats après simulation
  - Menu Affichage > Disposition (1×1, 1×2, 2×2, 2×3, 3×3)
- **Signal `profil_changed`** dans `tab_profils.py` :
  - Émis lors de drag, conversion Bézier, chargement fichier
  - Connecté à `mark_stale()` pour invalider les résultats
- **Signal `profil_edited`** dans `profil_canvas.py` :
  - Émis à la fin d'un drag de point de contrôle
- **Propriété `has_bl`** dans `SimulationResults` (`simulation.py`)

### Changed (Modifié)
- `profil_canvas.py` : ajout zoom molette centré sur curseur et pan bouton milieu
- `profil_canvas.py` : densité porcupines configurable (`_porcupine_n_quills = 200`)
- `profil_canvas.py` : échelle porcupines par défaut 1.0 → 200.0

## [Non publié] - 2026-02-14 00:30

### Added (Ajouté)
- **Format Bézier (.bez)** dans `profil.py` :
  - `_write_bezier()` : sauvegarde les points de contrôle (EXTRADOS/INTRADOS)
  - `_read_bezier()` : charge un profil en mode Bézier depuis un `.bez`
  - Détection automatique du format via l'extension `.bez`
  - Intégré dans `write()`, `from_file()` et `_detect_format()`
- **Checkboxes Courbure** dans `tab_profils.py` :
  - Activation/désactivation indépendante des porcupines courant et référence
  - `set_show_porcupines_current()` / `set_show_porcupines_reference()` dans le canvas
- **Enveloppes de courbure** dans `profil_canvas.py` :
  - Ligne reliant les sommets des porcupines (trait fin, couleur du profil)
  - 4 artists `_env_current_ext/int`, `_env_ref_ext/int`
- **Menu contextuel** (clic droit) dans `profil_canvas.py` :
  - Dialogue d'échelle courbure (`QInputDialog.getDouble`)
  - `_porcupine_scale` : facteur d'échelle appliqué aux porcupines
- **Contraintes de drag** dans `profil_canvas.py` :
  - P0 et P_last (extrémités) non déplaçables
  - P1 (à côté du BA) contraint en déplacement vertical uniquement

### Changed (Modifié)
- Porcupines inversées : les quills pointent vers l'intérieur du profil
- Ligne moyenne du profil courant en bleu (était vert)
- Dialogues Ouvrir/Sauvegarder : ajout du filtre Bézier (*.bez)

## [Non publié] - 2026-02-13 22:00

### Added (Ajouté)
- **Menus Fichier** dans `main_window.py` :
  - Ouvrir profil courant (Ctrl+O) et référence (Ctrl+Shift+O) via `QFileDialog`
  - Sauvegarder profil courant (Ctrl+S) en format Selig, Lednicer ou CSV
- **Menu Edition > Convertir en Bézier** (Ctrl+B) dans `main_window.py`
- **Régularisation par smoothing** dans `Bezier.approximate()` :
  - Paramètre `smoothing` : pénalise les différences secondes du polygone de contrôle
  - Méthode `_smoothing_matrix()` : matrice de régularisation Δ²
- **Contraintes de tangente** dans `Bezier.approximate()` :
  - Paramètres `start_tangent` / `end_tangent` (angle en degrés ou vecteur direction)
  - P1 contraint sur une droite P0 + α·d (1 DOF au lieu de 2), idem Pn-1
  - Méthodes `_parse_tangent()` et `_solve_clamped_with_tangents()`
- **Tangente verticale au BA** dans `Profil.approximate_bezier()` :
  - Paramètre `ba_vertical=True` : impose (0,+1) extrados, (0,-1) intrados
- `Bezier.from_file()` : chargement de points depuis un fichier texte (x y en colonnes)
- `TabProfils.load_profil_from_file()`, `save_current_profil()`, `convert_current_to_bezier()`
- Guard d'import dans `profil.py` pour exécution directe (`__main__`)

### Changed (Modifié)
- Profils chargés en **mode discret** par défaut (plus de conversion Bézier automatique)
- Le spinbox degré Bézier ne reconvertit que si le profil est déjà en mode Bézier
- Degré Bézier par défaut : 5 → 6
- `Bezier.__init__()` : nouveaux paramètres `smoothing`, `start_tangent`, `end_tangent`
- `Profil.approximate_bezier()` : nouveaux paramètres `smoothing`, `ba_vertical`

## [Non publié] - 2026-02-13 18:00

### Added (Ajouté)
- GUI interactive PySide6 + matplotlib dans `sources/gui/`
  - `main_window.py` : fenêtre principale avec menus (Fichier, Edition, Affichage, Aide) et 3 onglets
  - `tab_profils.py` : onglet Profils avec checkboxes courant/référence et spinbox degré Bézier
  - `profil_canvas.py` : canvas matplotlib interactif (profils, points de contrôle draggables, porcupines de courbure, polygone de contrôle, ligne moyenne)
  - `tab_xfoil.py`, `tab_results.py` : onglets placeholder
  - `run_gui.py` : lanceur de l'application
- Fichier `requirements.txt` (numpy, scipy, matplotlib, PySide6)
- Environnement virtuel Python 3 (`env_py3/`)

### Changed (Modifié)
- **Migration Python 3** de `sources/model/` :
  - 21 imports convertis en imports relatifs explicites (`from .bezier import Bezier`)
  - 3 classes abstraites migrées de `__metaclass__ = ABCMeta` vers `class Xxx(ABC)`
  - `xfoil_simulator.py` : subprocess modernisé (bytes + `timeout=` natif, suppression `threading.Timer`)
  - Correction du chemin `_find_xfoil()` (4 niveaux → 2 niveaux)
- **Restructuration** `airfoiltools/` → `sources/model/` + `sources/gui/`
  - `setup.py` : `package_dir` mapping explicite, Python >= 3.8, dépendances mises à jour
  - 6 fichiers de tests adaptés (`from model.xxx import Xxx`, sys.path vers `sources/`)
  - `CLAUDE.md` mis à jour (architecture, commandes, imports)
- `.gitignore` : ajout `env_py3/`, `.vscode/`, `.claude/`

### Removed (Supprimé)
- Import fallback Python 2 dans `profil.py` (`try/except ImportError`)
- `threading.Timer` dans `xfoil_simulator.py` (remplacé par `communicate(timeout=)`)
- Dépendance à Python 2.7 (`python_requires >= 2.7` → `>= 3.8`)
